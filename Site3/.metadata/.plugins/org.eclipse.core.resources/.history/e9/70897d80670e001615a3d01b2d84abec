package fabflix;

import java.io.IOException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import fabflix.Global;
import java.sql.*;


@WebServlet("/Login")
public class Login extends HttpServlet {
	private static final long serialVersionUID = 1L;
	
    public Login() {
        super();
    }

    
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		HttpSession session = request.getSession();
		String email = request.getParameter("email");    
	    String pwd = request.getParameter("password");
        RequestDispatcher dispatcher = null;
	    try {
			Class.forName("com.mysql.jdbc.Driver");
		
		    Connection con = DriverManager.getConnection("jdbc:mysql://localhost:3306/moviedb", Global.DB_USER, Global.DB_PASS);
		    // Statement st = con.createStatement();
		    // String query="select * from customers where email='" + email + "' and password= '" + pwd + "'";
		    // ResultSet rs = st.executeQuery(query);
	
		    String selectSQL = "select * from customers where email='" + email + "' and password='" + pwd + "'";
		    PreparedStatement preparedStatement = con.prepareStatement(selectSQL);
		    // // preparedStatement.setInt(1, 1001);
		    ResultSet rs = preparedStatement.executeQuery(selectSQL );
		    // out.println(query);
	
		    if (rs.next()) 
		    {
		        
		        //(rs.getInt(1),rs.getString(2),rs.getString(3),rs.getString(4),rs.getString(5),rs.getString(6));
		        //User x= new User(rs);
		        /*
		        id:integer (primary key)
				first_name:varchar(50) 
				last_name:varchar(50) 
				cc_id:varchar(20), referencing creditcards.id
				address:varchar(200) 
				email:varchar(50) 
				password:varchar(20) 
		        */
		        CartList cart = new CartList();
		        session.setAttribute("email",email);
		        session.setAttribute("id", rs.getInt(1));
		        session.setAttribute("first_name", rs.getString(2));
		        session.setAttribute("last_name", rs.getString(3));
		        session.setAttribute("cc_id", rs.getString(4));
		        session.setAttribute("address", rs.getString(5));
		        session.setAttribute("cart", cart);
		        //out.println("welcome " + email);
		        //out.println("<a href='logout.jsp'>Log out</a>");
				dispatcher = getServletContext().getRequestDispatcher(Global.homePath);
		        dispatcher.forward(request, response);
		    } 
		    else 
		    {
		        String redirectURL = Global.loginPath + "?message=Invalid%20password%20or%20User%20Name%2E%20Try%20Again%2E";
				dispatcher = getServletContext().getRequestDispatcher(redirectURL);
		        dispatcher.forward(request, response);
		    }
	    } catch (ClassNotFoundException | SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		doGet(request, response);
	}

}
